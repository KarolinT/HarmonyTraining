---
title: Hands-on training session 2
subtitle: Hui-Walter models for diagnostic test evaluation
date: "`r Sys.Date()`"
fontsize: 12pt
author:
  - Matt Denwood
  - Giles Innocent
theme: metropolis
aspectratio: 43
colortheme: seahorse
header-includes: 
  - \input{preamble}
fig_caption: true
classoption: compress, c
output:
    beamer_presentation:
        pandoc_args: ["-t", "beamer"]
        slide_level: 2
    html_document: default
---

```{r rendering, eval=FALSE, include=FALSE}
# To render this as both html and PDF (beamer) slides run:
rmarkdown::render('Adv2_HuiWalter.Rmd', 'all')
# Or just for html:
rmarkdown::render('Adv2_HuiWalter.Rmd', 'html_document')
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

## Overview

Date/time:

  - 19th February 2020
  - 16.00 - 17.00

Teachers:

  - Matt Denwood (presenter)
  - Giles Innocent

## Recap

Important points from session 1




# Session 2a:  Hui-Walter models for 2 tests and 1 population

## Hui-Walter Model

Background (not necessarily Bayesian)

Rabbits and hats

## Model Specification

Care with order of combinations in dmultinom


## Practicalities

Works best with strong priors for one of the tests

Label switching (se+sp > 0.5)

Lots of data needed

Convergence tricky

## Simulating data

How to simulate data for this and checking we can recover parameter values


```{r}
# R code simulating data
# Parameters
Prev1 <- 0.8  # prevalence
Se1 <- 0.8    # test sensitivity
Sp1 <- 0.95   # test specificity
n.obs <- 50   # Number of individuals tested (number of observations)
n.burnin <- 2000  # number of burn-in iterations for MCMC
n.sample <- 2000  # number of samples to take after burn-in
# simulation
true.positive <- rbinom(1, n.obs, Prev1)
test.positive <- rbinom(1, true.positive, Se1)
test.positive <- test.positive + rbinom(1, n.obs-true.positive, 1-Sp1)
# Jags/R code analysing data
```


## Exercise

Simulate data and recover parameters

Play around with different priors and watch autocorrelation etc


# Session 2b:  Hui-Walter models for 2 tests and N populations

## Model specification 1

Independent intercepts for populations


## Model specification 2

Random effect of population


## Practicalities

Need to be very careful with tabulating the data

Works best when populations have very different prevalences


## Auto Hui-Walter

Show autohuiwalter.R

Disable correlations by default

Modify so it allows Se/Sp priors to be defined as matrices?

And correlations on/off as matrices?

Will be in runjags at some point

## Exercise

Play around with the autohuiwalter function

